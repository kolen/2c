Перем ТипОбъекта;
Перем СписокТЧ Экспорт;


//___________________________________________________________________________________________
Функция ТипОбъекта()Экспорт
	 Возврат ТипОбъекта;
КонецФункции//ТипОбъекта

//___________________________________________________________________________________________
Процедура ПриНачалеРаботыСистемы()
	//Читаем общие настройки объекта
	Мета=СоздатьОбъект("ФайлМетаданных");//объект для работы с файлом метаданных
	Массив=Мета.ПрочитатьДанные("НастройкиДокументов");
	Если ТипЗначения(Массив)=5 Тогда
		КонтрольУникальности=Массив.КонтрольУникальности;
		АвтоНумерация=Массив.АвтоНумерация;
		МультиКонфигурации=Число(Массив.МультиКонфигурации);
	Иначе
		КонтрольУникальности=0;
		АвтоНумерация=1;
		МультиКонфигурации=0;
	КонецЕсли;



	Меню=СоздатьОбъект("Меню");
	Мета=СоздатьОбъект("Метаданные").Массив.Метаданные;
	

	ТипОбъекта="Документ";

	СписокТЧ=СоздатьОбъект("Структура"); 
	
	//читаем виды
	Если РазмерСтруктуры(Мета) Тогда
		Для А=1 По РазмерСтруктуры(Мета[ТипОбъекта]) Цикл
			Вид=Мета[ТипОбъекта].ИдентификаторПоНомеру(А);
			ИдентификаторБД=ПолучитьИдентификаторБД(ТипОбъекта+"/"+Вид);

			//Шапочная часть
			ШапкаДок=СоздатьОбъект("ТаблицаБД");
			ШапкаДок.ДобавитьПоле("#IsPosted","Строка",1,0);
			ШапкаДок.ДобавитьПоле("#ВремяДокумента","Число",9,0);//СЕК + МСЕК
			ШапкаДок.ДобавитьПоле("ДатаДок","Дата",0,0);
			ШапкаДок.ДобавитьПоле("НомерДок","Строка",10,0);
			
			МетаОбъект=Мета[ТипОбъекта][Вид]["Реквизиты"];
			Для Б=1 По РазмерСтруктуры(МетаОбъект) Цикл
				Имя=МетаОбъект.ИдентификаторПоНомеру(Б);
				//Проверки и уточнения
				Если Врег(Имя)="ДАТАДОК" Тогда
					 МетаОбъект[Имя].Тип="Дата";
					 МетаОбъект[Имя].Длина=0;
					 МетаОбъект[Имя].Точность=0;
				ИначеЕсли Врег(Имя)="НОМЕРДОК" Тогда
					Если ПустоеЗначение(МетаОбъект[Имя].Тип)=1 Тогда
						МетаОбъект[Имя].Тип="Строка";
						МетаОбъект[Имя].Длина=Макс(10,МетаОбъект[Имя].Длина);
					КонецЕсли
					МетаОбъект[Имя].Точность=0;
				ИначеЕсли Врег(Имя)="ВРЕМЯДОКУМЕНТА" Тогда
					Продолжить;
				КонецЕсли
				ИдентификаторРеквизитаБД=ПолучитьИдентификаторБД(ТипОбъекта+"/"+Вид+"/Реквизиты/"+Имя);
				ШапкаДок.ДобавитьПоле(Имя,МетаОбъект[Имя].Тип,МетаОбъект[Имя].Длина,МетаОбъект[Имя].Точность,ИдентификаторРеквизитаБД);
			КонецЦикла;
			
			ТипВид=ТипОбъекта+"."+Вид;
			Если ПустоеЗначение(ИдентификаторБД)=1 Тогда
				ТипВидБД=ТипВид;
			Иначе
				ТипВидБД=ТипОбъекта+"."+ИдентификаторБД;
			КонецЕсли
			
			ШапкаДок.НачальнаяИнициализация(ТипВид,"DH",1,МультиКонфигурации,ТипВидБД);
			
			//Табличная часть
			ТаблицаДок=СоздатьОбъект("ТабличнаяЧасть");
			Если ТаблицаДок.НачальнаяИнициализация(ТипОбъекта,Вид,МультиКонфигурации,ИдентификаторБД)=1 Тогда
				СписокТЧ[Вид]=1;
			КонецЕсли
			
//			//Табличная часть
//			Мета=СоздатьОбъект("Метаданные").Массив.Метаданные;
//			МетаОбъект=Мета[ТипОбъекта][Вид]["Табличная часть"];
//			Если РазмерСтруктуры(МетаОбъект)>0 Тогда
//				ТаблицаДок=СоздатьОбъект("ТаблицаБД");
//				ТаблицаДок.ДобавитьПоле("ТекущийДокумент","Документ");
//				ТаблицаДок.ДобавитьПоле("ПериодДвижения","Число",17,0);
//				ТаблицаДок.ДобавитьПоле("НомерСтроки","Число",17,0);
//				Для Б=1 По РазмерСтруктуры(МетаОбъект) Цикл
//					Имя=МетаОбъект.ИдентификаторПоНомеру(Б);
//					//Проверки
//					Если Врег(Имя)="ТЕКУЩИЙДОКУМЕНТ" Тогда
//						 Продолжить;
//					ИначеЕсли Врег(Имя)="ПЕРИОДДВИЖЕНИЯ" Тогда
//						 Продолжить;
//					ИначеЕсли Врег(Имя)="НОМЕРСТРОКИ" Тогда
//						 Продолжить;
//					КонецЕсли
//					ТаблицаДок.ДобавитьПоле(Имя,МетаОбъект[Имя].Тип,МетаОбъект[Имя].Длина,МетаОбъект[Имя].Точность);
//				КонецЦикла;
//				ТаблицаДок.НачальнаяИнициализация(ТипОбъекта+"."+Вид+".ТабличнаяЧасть","DT",0,0);
//				СписокТЧ[Вид]=1;
//			КонецЕсли
			
			//заполняем меню
			Обработчик=СоздатьОбъект(ТипОбъекта+"."+Вид);
			Меню.ДобавитьМеню(Вид,Обработчик,"ОткрытьСписок");
		КонецЦикла;
	КонецЕсли;
	
	Меню.ПоказатьМеню("Документы");
	
	
	ПодписатьсяНаСобытие("ТаблицаБДСписок:СозданиеКонтекстногоМеню","СозданиеКонтекстногоМеню");
КонецПроцедуры





//___________________________________________________________________________________________
Процедура СозданиеКонтекстногоМеню(Результат,ТекОбъект,СписокМеню)
	//ТекОбъект:Документ
	Если ВРЕГ(ТипЗначенияСтр(ТекОбъект))="ДОКУМЕНТ" Тогда
		Если ТекОбъект.Выбран() И НЕ ТекОбъект.ПометкаУдаления() Тогда
			СписокМеню.ДобавитьЗначение("");
			СписокМеню.ДобавитьЗначение(Контекст,"Провести");
			
			Если ТекОбъект.Проведен() Тогда
				СписокМеню.ДобавитьЗначение(Контекст,"Сделать не проведенным");
			КонецЕсли
		КонецЕсли
	КонецЕсли
КонецПроцедуры//СозданиеКонтекстногоМеню


//___________________________________________________________________________________________
Процедура ВыполнитьКомандуМеню(ИмяКоманды,ТекОбъект)Экспорт//выполнение команды контекстного меню
	//ТекОбъект:Документ
	Попытка
	Если ИмяКоманды="Провести" Тогда
		ТекОбъект.Провести();
	ИначеЕсли ИмяКоманды="Сделать не проведенным" Тогда
		ТекОбъект.СделатьНеПроведенным();
	Иначе
		Сообщить("Документ. Неизвестная команда меню: "+ИмяКоманды);
	КонецЕсли
	Исключение
		Сообщить(ОписаниеОшибки());
	КонецПопытки
	
КонецПроцедуры//ВыполнитьКоманду
