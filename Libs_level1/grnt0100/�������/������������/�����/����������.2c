//Автор:  Alex_Bob 
//E-mail: asbobylk@svsokol.lipetsk.ru
//Версия модуля: 1.00 от 29.06.2004
//Релиз платформы: позже 09.06.2004

///////////////////////////////////////////////////////////////////////
Перем НаборПрав;
Перем ИмяНабораПрав;
Перем Доступ;
Перем МД;

//---------------------------------------------------------------------
Процедура ВставитьВДерево(Мас,Родитель,Имя="",ТекПуть="")
	Если ТипЗначенияСтр(Мас)="Массив" Тогда
		Для А=1 По РазмерСтруктуры(Мас) Цикл
			ТекИмя=Мас.ИдентификаторПоНомеру(А);
			ИмяРодителя=Дерево.ПолучитьТекст(Родитель);
			Если (ТекИмя="Справочник" ИЛИ ТекИмя="Документ") И ИмяРодителя="Метаданные" Тогда
				Продолжить
			КонецЕсли

			ИмяЭлемента=ТекИмя;
			Если Лев(ТекПуть,1)="/" Тогда
				ТекПуть=Сред(ТекПуть,2); 
			КонецЕсли
			Путь=ТекПуть+"/"+ТекИмя+".frm";
            Стр="";
    		Син="";
    		Ком=""; 
			МД.ПрочитатьТекст(Путь,Стр,Син,Ком);
			    
			Если СтрДлина(Стр)>0 Тогда
		   		ИмяЭлемента=ТекИмя;
				Картинка=18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь));
				ТекЭлемент=Дерево.ВставитьЭлемент(ИмяЭлемента,Картинка,Родитель); 
                Продолжить;
			КонецЕсли;
			//Сообщить(ТекПуть);
			Если ТипЗначенияСтр(Мас[ТекИмя])<>"Массив" Тогда
			    
			Иначе
			    Путь=ТекПуть+"/"+ТекИмя;
			    Картинка=187+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь));	
			    ТекЭлемент=Дерево.ВставитьЭлемент(ИмяЭлемента,Картинка,Родитель);
			КонецЕсли
			ВставитьВДерево(Мас[ТекИмя],ТекЭлемент,ТекИмя,Путь);
		КонецЦикла;
	КонецЕсли
КонецПроцедуры
//---------------------------------------------------------------------
Функция КоличествоПодчиненных(ЭД)
	Дерево.ВыбратьПодчиненныеЭлементы(ЭД);
	Сч=0;
	Пока Дерево.ПолучитьЭлемент(0)=1 Цикл
		Сч=Сч+1; 
	КонецЦикла
	Возврат Сч;
КонецФункции//КоличествоПодчиненных
//---------------------------------------------------------------------
Функция ПолучитьИмяФормы(Путь)
	ИмяФормы=СтрЗаменить(Путь,"/","\");
	Если Лев(ИмяФормы,1)="\" Тогда
		ИмяФормы=Сред(ИмяФормы,2); 
	КонецЕсли
	Если Лев(ИмяФормы,3)="MD:" Тогда
		ИмяФормы=Сред(ИмяФормы,4);
        Если Лев(ИмяФормы,1)="\" Тогда
		    ИмяФормы=Сред(ИмяФормы,2); 
	    КонецЕсли
	Иначе	 
		ИмяФормы="Метаданные\"+ИмяФормы;
	КонецЕсли
	Если Прав(ИмяФормы,4)=".frm" Тогда
	    ИмяФормы=Лев(ИмяФормы,СтрДлина(ИмяФормы)-4);
	КонецЕсли
	Возврат ИмяФормы;
КонецФункции//ПолучитьИмяФормы
//---------------------------------------------------------------------
Процедура УдалитьУзлыБезЛистьев(ЭлементДерева)
    Корень=ЭлементДерева;
	ТолькоЧтоВышли=0;
	Пока ЭлементДерева>0 Цикл
		
		КП=КоличествоПодчиненных(ЭлементДерева);
		Если КП>0 Тогда
			Если ТолькоЧтоВышли=1 Тогда
			    Следующий=Дерево.ПолучитьСледующий(ЭлементДерева);
				Если Следующий>0 Тогда
					ЭлементДерева=Следующий; 
				    ТолькочтоВышли=0; 
				Иначе
					Родитель=Дерево.ПолучитьРодителя(ЭлементДерева);
					ЭлементДерева=Родитель;
					ТолькоЧтоВышли=1;
				КонецЕсли
			Иначе
			    Подчиненный=Дерево.ПолучитьПодчиненный(ЭлементДерева);
				ЭлементДерева=Подчиненный;
			КонецЕсли
	   	Иначе	 
			Если Дерево.ПолучитьКартинку(ЭлементДерева)>185 Тогда
				Родитель=Дерево.ПолучитьРодителя(ЭлементДерева);
				Дерево.УдалитьЭлемент(ЭлементДерева); 
				ЭлементДерева=Родитель;
			Иначе
				Следующий=Дерево.ПолучитьСледующий(ЭлементДерева);
				Если Следующий>0 Тогда
					ЭлементДерева=Следующий; 
				Иначе
					Родитель=Дерево.ПолучитьРодителя(ЭлементДерева);
					ЭлементДерева=Родитель;
					ТолькоЧтоВышли=1;
				КонецЕсли
			КонецЕсли
			
		КонецЕсли
	КонецЦикла
	
КонецПроцедуры
///////////////////////////////////////////////////////////////////////
Функция ПолучитьИмяФормыДерево()
    ТекЛист=Дерево.ВыделенныйЭлемент();
    ИмяФормы=Дерево.ПолучитьТекст(ТекЛист);
    ТекСтрока="";
    Пока Текстрока<>"Формы конфигурации" Цикл
        Родитель=Дерево.ПолучитьРодителя(ТекЛист);
        ТекСтрока=Дерево.ПолучитьТекст(Родитель);
        Если ТекСтрока="Справочники" Тогда
        	ИмяФормы="Метаданные\Справочник\"+ИмяФормы;
        	Возврат ИмяФормы;
        КонецЕсли;
        Если ТекСтрока="Документы" Тогда
        	ИмяФормы="Метаданные\Документ\"+ИмяФормы;
        	Возврат ИмяФормы;
        КонецЕсли;
        ИмяФормы=ТекСтрока+"\"+ИмяФормы;
        ТекЛист=Родитель;
    КонецЦикла;    
    ИмяФормы=Сред(ИмяФормы,20);
    Сообщить(ИмяФормы);
	Возврат ИмяФормы; 
КонецФункции//ПолучитьИмяФормыДерево

///////////////////////////////////////////////////////////////////////
Процедура ПостроитьДерево()
	Если Доступ.ПравоДоступаВсе(НаборПрав)=1 Тогда
		Корень=Дерево.ВставитьЭлемент("Все права",188);
	Иначе
		Корень=Дерево.ВставитьЭлемент("Все права",187);
		Дерево.ВставитьЭлемент("Права администратора",187+Доступ.ПравоДоступаАдм(НаборПрав),Корень);
		Дерево.ВставитьЭлемент("Внешние формы",187+Доступ.ПравоДоступаВнешние(НаборПрав),Корень);
		Формы=Дерево.ВставитьЭлемент("Формы конфигурации",187,Корень);
		Мета=СоздатьОбъект("Метаданные").Массив;
		ОбщиеФормы=Дерево.ВставитьЭлемент("Общие формы",187+Доступ.ПравоДоступаФорма(НаборПрав,"use",""),Формы);
		ВставитьВДерево(Мета["Общие формы"],ОбщиеФормы,,"MD:Общие формы");
		Мета=СоздатьОбъект("Метаданные").Массив.Объекты;
		Объекты=Дерево.ВставитьЭлемент("Объекты",187+Доступ.ПравоДоступаФорма(НаборПрав,"use",""),Формы);
		ВставитьВДерево(Мета,Объекты,,"MD:Объекты");
		Мета=СоздатьОбъект("Метаданные").Массив.Метаданные;
		Метаданные=Дерево.ВставитьЭлемент("Метаданные",187+Доступ.ПравоДоступаФорма(НаборПрав,"use",""),Формы);
		ВставитьВДерево(Мета,Метаданные,);
		УдалитьУзлыБезЛистьев(Объекты);
		ОбъектыМетаданных=Дерево.ВставитьЭлемент("Объекты метаданных",187,Корень);
		Мета=СоздатьОбъект("Метаданные").Массив.Метаданные.Документ;
		ОбъектМетаДок=Дерево.ВставитьЭлемент("Документы",84,ОбъектыМетаданных);
		Для А=1 По РазмерСтруктуры(Мета) Цикл
			ДокВид=Мета.ИдентификаторПоНомеру(А);
			
			Объект=СоздатьОбъект("Документ."+ДокВид);
			Док=Дерево.ВставитьЭлемент(ДокВид,216,ОбъектМетаДок);
			Путь="Документ/"+ДокВид+"/Форма диалога.frm";
			Если СуществуетФорма(Путь) Тогда
				ДокФД=Дерево.ВставитьЭлемент("Форма диалога",18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь)),Док);
			КонецЕсли
			Путь="Документ/"+ДокВид+"/Список элементов.frm";
			Если СуществуетФорма(Путь) Тогда
				ДокСЭ=Дерево.ВставитьЭлемент("Список элементов",18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь)),Док);
			КонецЕсли	
			ДокЗапись=Дерево.ВставитьЭлемент("Запись",18+Доступ.ПравоДоступаОбъект(НаборПрав,"write",Объект.НомерТаблицыОбъекта()),Док);
			Дерево.УстановитьДанные(ДокЗапись,Объект.НомерТаблицыОбъекта());
			ДокУдаление=Дерево.ВставитьЭлемент("Удаление",18+Доступ.ПравоДоступаОбъект(НаборПрав,"delete",Объект.НомерТаблицыОбъекта()),Док);
            Дерево.УстановитьДанные(ДокУдаление,Объект.НомерТаблицыОбъекта()); 	
            ДокПроведение=Дерево.ВставитьЭлемент("Проведение",18+Доступ.ПравоДоступаОбъект(НаборПрав,"action",Объект.НомерТаблицыОбъекта()),Док);
            Дерево.УстановитьДанные(ДокУдаление,Объект.НомерТаблицыОбъекта()); 		
		КонецЦикла

		Мета=СоздатьОбъект("Метаданные").Массив.Метаданные.Справочник;
		ОбъектМетаСпр=Дерево.ВставитьЭлемент("Справочники",85,ОбъектыМетаданных);
		Для А=1 По РазмерСтруктуры(Мета) Цикл
			СпрВид=Мета.ИдентификаторПоНомеру(А);
			Объект=СоздатьОбъект("Справочник."+СпрВид);
			Спр=Дерево.ВставитьЭлемент(СпрВид,226,ОбъектМетаСпр);
			Путь="Справочник/"+СпрВид+"/Форма диалога.frm";
			Если СуществуетФорма(Путь) Тогда
				СпрФД=Дерево.ВставитьЭлемент("Форма диалога",18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь)),Спр);
			КонецЕсли
			Путь="Справочник/"+СпрВид+"/Форма группы.frm";
			Если СуществуетФорма(Путь) Тогда
				СпрФГ=Дерево.ВставитьЭлемент("Форма группы",18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь)),Спр);
			КонецЕсли
			Путь="Справочник/"+СпрВид+"/Список элементов.frm";
			Если СуществуетФорма(Путь) Тогда
				СпрСЭ=Дерево.ВставитьЭлемент("Список элементов",18+Доступ.ПравоДоступаФорма(НаборПрав,"use",ПолучитьИмяФормы(Путь)),Спр);
			КонецЕсли
			СпрЗапись=Дерево.ВставитьЭлемент("Запись",18+Доступ.ПравоДоступаОбъект(НаборПрав,"write",Объект.НомерТаблицыОбъекта()),Спр);
			Дерево.УстановитьДанные(СпрЗапись,Объект.НомерТаблицыОбъекта());
			СпрУдаление=Дерево.ВставитьЭлемент("Удаление",18+Доступ.ПравоДоступаОбъект(НаборПрав,"delete",Объект.НомерТаблицыОбъекта()),Спр);
            Дерево.УстановитьДанные(СпрУдаление,Объект.НомерТаблицыОбъекта());
		КонецЦикла
		Дерево.Разворот(Корень); 
	КонецЕсли
КонецПроцедуры//ПостроитьДерево

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	Конт=Форма.Параметр;
	Если ТипЗначенияСтр(Конт)="СписокЗначений" Тогда
		Доступ=СоздатьОбъект("ПраваДоступа");
		МД=СоздатьОбъект("ФайлМетаданных");
        
        НаборПрав=Конт.ПолучитьЗначение(1);
        ИмяНабораПрав=Конт.ПолучитьЗначение(2);
		ПостроитьДерево();
	Иначе
	    Форма.Закрыть();		 
	КонецЕсли
	
    
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Выполнить
Процедура ПриВыбореЛиста()
    ТекЛист=Дерево.ВыделенныйЭлемент();
    ФС=СоздатьОбъект("Файловая система");
    Польз=СоздатьОбъект("Пользователи");
    Сп=СоздатьОбъект("СписокЗначений");
    Если Дерево.ПолучитьТекст(ТекЛист)="Все права" Тогда
    	Если Дерево.ПолучитьКартинку(ТекЛист)=187 Тогда
    	    //Установить все права
    	    Доступ.Новый();
    	    Доступ.ИД=Доступ.ПолучитьНовыйИД();
    	    Доступ.НаборПрав=НаборПрав;
    	    Доступ.ТипПрава="all";
    	    Доступ.Записать();
    	Иначе	 
    	    //Удалить все права
    	    Доступ.ВыбратьЭлементы();
    	    Пока Доступ.ПолучитьЭлемент()=1  Цикл
    	    	Если (Доступ.НаборПрав=НаборПрав) И
    	    	     (Доступ.ТипПрава="all") Тогда
    	    		Доступ.Удалить(); 
    	    	КонецЕсли
    	    КонецЦикла
    	КонецЕсли
    	Дерево.УдалитьВсе();
    	ПостроитьДерево();
    ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Права администратора" Тогда
        Если Дерево.ПолучитьКартинку(ТекЛист)=187 Тогда
    	    //Установить права администратора
    	    Доступ.Новый();
    	    Доступ.ИД=Доступ.ПолучитьНовыйИД();
    	    Доступ.НаборПрав=НаборПрав;
    	    Доступ.ТипПрава="adm";
    	    Доступ.Записать();
    	    Польз.ВыбратьЭлементы();
    	    Пока Польз.ПолучитьЭлемент()=1 Цикл
    	    	Если Польз.НаборПрав=НаборПрав Тогда
    	    		Сп.ДобавитьЗначение(Польз.Имя,Польз.Пароль);  
    	    	КонецЕсли
    	    КонецЦикла
    	    ЗначениеВФайл(КаталогИБ()+"USERS\"+НаборПрав+".usr",Сп);
    	    Дерево.УстановитьКартинку(ТекЛист,188);
    	Иначе	 
    	    //Удалить права администратора
    	    Доступ.ВыбратьЭлементы();
    	    Пока Доступ.ПолучитьЭлемент()=1  Цикл
    	    	Если (Доступ.НаборПрав=НаборПрав) И
    	    	     (Доступ.ТипПрава="adm") Тогда
    	    		Доступ.Удалить(); 
    	    	КонецЕсли
    	    КонецЦикла
    	    ФС.УдалитьФайл(КаталогИБ()+"USERS\"+НаборПрав+".usr");
    	    Дерево.УстановитьКартинку(ТекЛист,187);
    	КонецЕсли
    ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Внешние формы" Тогда
        Если Дерево.ПолучитьКартинку(ТекЛист)=187 Тогда
    	    //Установить права на запуск внешних отчетов
    	    Доступ.Новый();
    	    Доступ.ИД=Доступ.ПолучитьНовыйИД();
    	    Доступ.НаборПрав=НаборПрав;
    	    Доступ.ТипПрава="ext";
    	    Доступ.Записать();
    	    Дерево.УстановитьКартинку(ТекЛист,188);
    	Иначе	 
    	    //Удалить права на запуск внешних отчетов
    	    Доступ.ВыбратьЭлементы();
    	    Пока Доступ.ПолучитьЭлемент()=1  Цикл
    	    	Если (Доступ.НаборПрав=НаборПрав) И
    	    	     (Доступ.ТипПрава="ext") Тогда
    	    		Доступ.Удалить(); 
    	    	КонецЕсли
    	    КонецЦикла
    	    Дерево.УстановитьКартинку(ТекЛист,187);
    	КонецЕсли
    ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Документы" Тогда
	ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Справочники" Тогда
	ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Объекты метаданных" Тогда
	ИначеЕсли Дерево.ПолучитьКартинку(ТекЛист)=226 Тогда
	ИначеЕсли Дерево.ПолучитьКартинку(ТекЛист)=216 Тогда
    ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Запись" Тогда
	    ИзменитьСтатусПраваОбъекта("write",18,ТекЛист);
    ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Удаление" Тогда
	    ИзменитьСтатусПраваОбъекта("delete",18,ТекЛист);						    
	ИначеЕсли Дерево.ПолучитьТекст(ТекЛист)="Проведение" Тогда
	    ИзменитьСтатусПраваОбъекта("action",18,ТекЛист);
	Иначе
		Если Дерево.ПолучитьКартинку(ТекЛист)=18 Тогда
	        //Установить права на запуск формы
    	    Доступ.Новый();
    	    Доступ.ИД=Доступ.ПолучитьНовыйИД();
    	    Доступ.НаборПрав=НаборПрав;
    	    Доступ.ТипПрава="use";
    	    Доступ.Форма=ПолучитьИмяФормыДерево();
    	    Доступ.Записать();
    	    Дерево.УстановитьКартинку(ТекЛист,19);
    	ИначеЕсли Дерево.ПолучитьКартинку(ТекЛист)=19 Тогда	 
    	    //Удалить права на запуск формы
    	    Доступ.ВыбратьЭлементы();
    	    Пока Доступ.ПолучитьЭлемент()=1  Цикл
    	    	Если (Доступ.НаборПрав=НаборПрав) И
    	    	     (Доступ.ТипПрава="use") И
    	    	     (Доступ.Форма=ПолучитьИмяФормыДерево()) Тогда
    	    		Доступ.Удалить(); 
    	    	КонецЕсли
    	    КонецЦикла
    	    Дерево.УстановитьКартинку(ТекЛист,18);
    	КонецЕсли	 
    КонецЕсли
КонецПроцедуры

Процедура ИзменитьСтатусПраваОбъекта(СтрПраво,Картинка,ЭлементДерева)
	Если Дерево.ПолучитьКартинку(ЭлементДерева)=Картинка Тогда
		//Установить права
		Доступ.Новый();
		Доступ.ИД=Доступ.ПолучитьНовыйИД();
		Доступ.НаборПрав=НаборПрав;
		Доступ.ТипПрава=СтрПраво;
		Доступ.ОбъектМетаданных=Дерево.ПолучитьДанные(ЭлементДерева);
		Доступ.Записать();
		Дерево.УстановитьКартинку(ЭлементДерева,Картинка+1);
	ИначеЕсли Дерево.ПолучитьКартинку(ЭлементДерева)=Картинка+1 Тогда	 
		//Удалить права
		Доступ.ВыбратьЭлементы();
		Пока Доступ.ПолучитьЭлемент()=1  Цикл
			Если (Доступ.НаборПрав=НаборПрав) И
				(Доступ.ТипПрава=СтрПраво) И
				(Доступ.ОбъектМетаданных=Дерево.ПолучитьДанные(ЭлементДерева)) Тогда
				Доступ.Удалить(); 
			КонецЕсли
		КонецЦикла
		Дерево.УстановитьКартинку(ЭлементДерева,Картинка);
	КонецЕсли;						       
КонецПроцедуры//ИзменитьПравоОбъекта

//___________________________________________________________________________________________
Функция СуществуетФорма(Путь)
	Стр="";
    Син="";
    Ком=""; 
	МД.ПрочитатьТекст(Путь,Стр,Син,Ком);
	Если Стр>0 Тогда
		Возврат 1;
	Иначе
		Возврат 0;	
	КонецЕсли

КонецФункции//СуществуетФорма(Путь)

