Перем ПИ;
Перем ТекЭлемент;
Перем Родитель;
Перем ТекПозиция;
Перем Интерфейс;
Перем Картинка;
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
	Конт=Форма.Параметр;
	Если ТипЗначенияСтр(Конт)="СписокЗначений" Тогда
	    ТекЭлемент=Конт.ПолучитьЗначение(1);
	    Родитель=Конт.ПолучитьЗначение(2);
	    ТекПозиция=Конт.ПолучитьЗначение(3);
	    Заголовок=Конт.ПолучитьЗначение(4);
	    Интерфейс=Конт.ПолучитьЗначение(5);
	    Картинка=Конт.ПолучитьЗначение(6);
	    ПИ=СоздатьОбъект("ПанелиИнструментовПользователя");
	    Таблица.Картинка(0,0,Картинка);
	    ПостроитьСписокКоманд();
	    Если ТекЭлемент=0 Тогда
	    Иначе	 
	        ПИ.УстановитьИмяИдентификатора("ИД");
	        ПИ.УстановитьИдентификаторОбъекта(ТекЭлемент);
	        ПИ.НайтиЭлементВБД();
	        ТекСтрока=Команда.НайтиЗначение(ПИ.Команда);
	        Если ТекСтрока>0 Тогда
	            Команда.ТекущаяСтрока(ТекСтрока);	 
	        КонецЕсли
	        ПараметрФормы=ПИ.Параметр;
	        МодальностьФормы=ПИ.Модальность;
	    КонецЕсли
	    Если Родитель=0 Тогда
	        Форма.Команда.Доступность(0);
	        Форма.ПараметрФормы.Доступность(0);
	        Форма.МодальностьФормы.Доступность(0); 
	    КонецЕсли
	    
	Иначе
	    ЗакрытьФорму();	 
	КонецЕсли
	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Отмена - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки ОК
Процедура ПриНажатииОК()
	Если (Заголовок="<новый...>") ИЛИ
		(Заголовок="<новая колонка...>") Тогда
		Предупреждение("Измените название элемента меню!"); 
		Возврат; 
	КонецЕсли
	ПИ.НачатьТранзакцию();
	Если ТекЭлемент=0 Тогда
		ПИ.Новый();
		ПИ.ИД=Число(ПолучитьЗначениеЗапроса("SELECT max("+ПИ.ПолучитьИмяПоляБД("ИД")+") FROM "+ПИ.ИмяТаблицыОбъекта()))+1; 
	Иначе
		ПИ.УстановитьИмяИдентификатора("ИД");
		ПИ.УстановитьИдентификаторОбъекта(ТекЭлемент);
		ПИ.НайтиЭлементВБД();
	КонецЕсли
	ПИ.Родитель=Родитель;
	ПИ.Заголовок=Заголовок;
	Если Родитель>0 Тогда
		Представление="";
		Значение=Команда.ПолучитьЗначение(Команда.ТекущаяСтрока(),Представление);
		Если Сред(Значение,1,13)="ОткрытьСписок" Тогда
			ПИ.Объект=Сред(Представление,1,СтрДлина(Представление)-8);
		    ПИ.Команда=Значение+"."+ПИ.Объект;
		Иначе
		    ПИ.Команда=Значение;
		КонецЕсли
		
		ПИ.Параметр=ПараметрФормы;	 
	КонецЕсли
	ПИ.Позиция=ТекПозиция;  
	ПИ.Интерфейс=Интерфейс; 
	ПИ.Модальность=МодальностьФормы; 
	ПИ.Пиктограмма=Картинка;
	ПИ.Записать();
	ПИ.ЗафиксироватьТранзакцию();
	ЗакрытьФорму();
КонецПроцедуры//ПриНажатииОК

//---------------------------------------------------------------------
Функция ПолучитьЗначениеЗапроса(Текст)
	ПИ.Запрос(Текст);
	Если ПИ.ПолучитьСтроку()=1 Тогда
		Возврат ПИ.ПолучитьПоле(1);
	КонецЕсли
	Возврат "";
КонецФункции//ПолучитьЗначениеЗапроса

//---------------------------------------------------------------------
Процедура ПостроитьСписокКоманд()
    Мета=СоздатьОбъект("Метаданные").Массив["Общие формы"];
    Для Сч=1 По РазмерСтруктуры(Мета) Цикл
        ИмяФормы=Мета.ИдентификаторПоНомеру(Сч);
        Значение="Общие формы\"+ИмяФормы;
        Представление="ОбщиеФормы."+ИмяФормы+".Открыть";
        Команда.ДобавитьЗначение(Значение,Представление);
    КонецЦикла;
    Мета=СоздатьОбъект("Метаданные").Массив.Объекты;
    Для Сч=1 По РазмерСтруктуры(Мета) Цикл
        ТипОбъекта=Мета.ИдентификаторПоНомеру(Сч);
        Для Сч1=1 По РазмерСтруктуры(Мета[ТипОбъекта]["Формы"]) Цикл
            ИмяФормы=Мета[ТипОбъекта]["Формы"].ИдентификаторПоНомеру(Сч1);
            Значение="Объекты\"+ТипОбъекта+"\Формы\"+ИмяФормы;
            Представление="ФормыОбъектов."+ТипОбъекта+"."+ИмяФормы+".Открыть";
            Команда.ДобавитьЗначение(Значение,Представление);
        КонецЦикла;
    КонецЦикла;    
    Мета=СоздатьОбъект("Метаданные").Массив.Метаданные;
    Для Сч=1 По РазмерСтруктуры(Мета) Цикл
        ТипОбъекта=Мета.ИдентификаторПоНомеру(Сч);
        Для Сч1=1 По РазмерСтруктуры(Мета[ТипОбъекта]) Цикл
            ВидОбъекта=Мета[ТипОбъекта].ИдентификаторПоНомеру(Сч1);
            Если (ТипОбъекта="Справочник") ИЛИ
                 (ТипОбъекта="Документ") ИЛИ
                 (ТипОбъекта="Операции") Тогда
               	Значение="ОткрытьСписок."+ТипОбъекта+"."+ВидОбъекта;
                Представление=ТипОбъекта+"."+ВидОбъекта+".Открыть";
            	Команда.ДобавитьЗначение(Значение,Представление);
            ИначеЕсли (ТипОбъекта="Обработка") ИЛИ
                      (ТипОбъекта="Отчет") Тогда
               	Значение=ТипОбъекта+"."+ВидОбъекта;       	 
               	Представление=ТипОбъекта+"."+ВидОбъекта+".Открыть";
            	Команда.ДобавитьЗначение(Значение,Представление);
            КонецЕсли
        КонецЦикла;    
    КонецЦикла;
    
КонецПроцедуры//ПостроитьСписокКоманд()

Процедура ПриВыбореПиктограммы()
	ОткрытьФормуМодально("Объекты\ПанелиИнструментовПользователя\Формы\ВыборПиктограммы");
	ФС=СоздатьОбъект("Файловая система");
	Если ФС.СуществуетФайл(КаталогВременныхФайлов()+"icon") Тогда
		НомКартинки=0;
		ЗначениеИзФайла(КаталогВременныхФайлов()+"icon",НомКартинки);
		
		Если Число(НомКартинки)>0 Тогда
			Картинка=Число(НомКартинки);
		    Таблица.Картинка(0,0,Картинка);
		    Таблица.Обновить();    	
		КонецЕсли
		ФС.УдалитьФайл(КаталогВременныхФайлов()+"icon");
		
	КонецЕсли

КонецПроцедуры//ПриВыбореПиктограммы


