Перем Интерфейс;
Перем ИмяИнтерфейса;
Перем ПИ;
Перем ПИСтр;
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
	Конт=Форма.Параметр;
	Если ТипЗначенияСтр(Конт)="СписокЗначений" Тогда
		ПИ=СоздатьОбъект("ПанелиИнструментовПользователя");
		МД=СоздатьОбъект("ФайлМетаданных");
		
        Интерфейс=Конт.ПолучитьЗначение(1);
        ИмяИнтерфейса=Конт.ПолучитьЗначение(2);
		ПостроитьДерево();
	Иначе
	    Форма.Закрыть();		 
	КонецЕсли
	
КонецПроцедуры
///////////////////////////////////////////////////////////////////////
Процедура ОткрытьМастер()
    Сп=СоздатьОбъект("СписокЗначений");
    Сп.ДобавитьЗначение(Интерфейс); 
    ОткрытьФормуМодально("Объекты\ГлавноеМеню\Формы\Мастер",Сп);
    Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ОткрытьМастер
///////////////////////////////////////////////////////////////////////
Процедура УдалитьЭлемент()
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
	    Возврат;
	Иначе
        Ответ=Вопрос("Вы действительно хотите удалить элемент панели <"+ТекстВыделенный+">?",4);
        Если Ответ=6 Тогда
            ПИ.НачатьТранзакцию();
			ПИ.УстановитьИмяИдентификатора("ИД");
			ПИ.УстановитьИдентификаторОбъекта(ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД);
			ПИ.НайтиЭлементВБД();
			Родитель=ПИ.Родитель;
			ПИ.Удалить();
			ПИ.ВыбратьЭлементыПанели(Интерфейс,Родитель);
			Позиция=1;
			Пока ПИ.ПолучитьЭлемент()=1 Цикл
				ПИ.Позиция=Позиция;
				ПИ.Записать();
				Позиция=Позиция+1; 
			КонецЦикла
			ПИ.ЗафиксироватьТранзакцию();
			Дерево.УдалитьВсе();
    		ПостроитьДерево(); 
		КонецЕсли;	
	КонецЕсли
КонецПроцедуры//УдалитьЭлементМеню  
///////////////////////////////////////////////////////////////////////
Процедура ОткрытьЭлемент()
	Пиктограмма=1;
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Родитель=0;
	    ТекЭлемент=0;
	    ТекПозиция=РазмерСтруктуры(ПИСтр)+1;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    ПИ.УстановитьИмяИдентификатора("Ид");
	    ПИ.УстановитьИдентификаторОбъекта(ПИСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))].ИД);
	    ПИ.НайтиЭлементВБД();
	    Родитель=ПИ.ИД;
	    ТекЭлемент=0;
	    ТекПозиция=РазмерСтруктуры(ПИСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))])+1;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
	    Возврат;
	Иначе
        ПИ.УстановитьИмяИдентификатора("Ид");
 	    ПИ.УстановитьИдентификаторОбъекта(ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД);
 	    ПИ.НайтиЭлементВБД();
	    ТекЭлемент=ПИ.ИД;
	    Родитель=ПИ.Родитель;
	    ТекПозиция=ПИ.Позиция;
	    Пиктограмма=ПИ.Пиктограмма;
 	КонецЕсли;
	Сп=СоздатьОбъект("СписокЗначений");
	Сп.ДобавитьЗначение(ТекЭлемент);
	Сп.ДобавитьЗначение(Родитель);
	Сп.ДобавитьЗначение(ТекПозиция);
	Сп.ДобавитьЗначение(ТекстВыделенный);
	Сп.ДобавитьЗначение(Интерфейс);
	Сп.ДобавитьЗначение(Пиктограмма);
	ОткрытьФормуМодально("Объекты\ПанелиИнструментовПользователя\Формы\ПиктограммаПанели",Сп);
	Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ОткрытьЭлемент 
///////////////////////////////////////////////////////////////////////
Процедура ПостроитьДерево()
    ПИСтр=СоздатьОбъект("Структура");
    ПИ.ВыбратьЭлементыПанели(Интерфейс,0);
    Корень=Дерево.ВставитьЭлемент("<Интерфейс:"+ИмяИнтерфейса+">",541);
    Пока ПИ.ПолучитьЭлемент()=1 Цикл
    	ТекЭлемент=Дерево.ВставитьЭлемент(ПИ.Заголовок,233,Корень);
        ИД=ПИ.ИД;
        Позиция=ПИ.Позиция;
        ПИСтр[Строка(ТекЭлемент)]["ИД"]=ИД;
        ПИСтр[Строка(ТекЭлемент)]["Позиция"]=Позиция;
    	ПИ1=СоздатьОбъект("ПанелиИнструментовПользователя");
    	ПИ1.ВыбратьЭлементыПанели(Интерфейс,ПИ.ИД);
    	Пока ПИ1.ПолучитьЭлемент()=1 Цикл
	    	Если ПИ1.Пиктограмма=0 Тогда
	    		НомКартинки=233;
	    	Иначе
		    	НомКартинки=ПИ1.Пиктограмма;	
	    	КонецЕсли
    		ТЭ=Дерево.ВставитьЭлемент(ПИ1.Заголовок,НомКартинки,ТекЭлемент);
    		ИД=ПИ1.ИД;
        	Позиция=ПИ1.Позиция;
        	ПИСтр[Строка(ТЭ)]["ИД"]=ИД;
        	ПИСтр[Строка(ТЭ)]["Позиция"]=Позиция;
       	КонецЦикла
    	Дерево.ВставитьЭлемент("<новый...>",255,ТекЭлемент);
    КонецЦикла;
    Дерево.ВставитьЭлемент("<новая колонка...>",255,Корень);
    Дерево.Разворот(Корень);
КонецПроцедуры//ПостроитьДерево
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры
//Процедура обработки нажатия кнопки КнВверх
Процедура ПриНажатииКнВверх()
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
	    Возврат;
	КонецЕсли;    
    
    ТекПозиция=ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].Позиция;
    ТекИД=ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД;
    ПредПозиция=ТекПозиция;
    ПредИД=ТекИД;
    НачЭлементСписка=Строка(Дерево.ПолучитьПодчиненный(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент())));
    Элемент=НачЭлементСписка;
    Пока 1=1 Цикл
        Если ПИСтр[Элемент].ИД=ТекИД Тогда
        	Прервать; 
        КонецЕсли;
        ПредИД=ПИСтр[Элемент].ИД;
        ПредПозиция=ПИСтр[Элемент].Позиция;
        Элемент=Строка(Дерево.ПолучитьСледующий(Число(Элемент)));
    КонецЦикла
    
    Если ТекИД=ПредИД Тогда
    Иначе
        ПИ.НачатьТранзакцию();
        ПИ.УстановитьИмяИдентификатора("Ид");
 	    ПИ.УстановитьИдентификаторОбъекта(ПредИД);
 	    ПИ.НайтиЭлементВБД(); 
 	    ПИ.Позиция=ТекПозиция;
 	    ПИ.Записать();
 	    ПИ.УстановитьИмяИдентификатора("Ид");
 	    ПИ.УстановитьИдентификаторОбъекта(ТекИД);
 	    ПИ.НайтиЭлементВБД(); 
 	    ПИ.Позиция=ПредПозиция;
 	    ПИ.Записать();
 	    ПИ.ЗафиксироватьТранзакцию();
    КонецЕсли
    Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ПриНажатииКнВверх

//Процедура обработки нажатия кнопки КнВниз
Процедура ПриНажатииКнВниз()
	ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
		Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
		Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
		Возврат;
	КонецЕсли;    
	ВсегоПозиций=РазмерСтруктуры(ПИСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))]);
	ТекПозиция=ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].Позиция;
	ТекИД=ПИСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД;
	СледЭлемент=Строка(Дерево.ПолучитьСледующий(Дерево.ВыделенныйЭлемент()));
	Если ТипЗначенияСтр(ПИСтр[СледЭлемент])="Массив" Тогда
	    СледПозиция=ПИСтр[СледЭлемент].Позиция;
	    СледИД=ПИСтр[СледЭлемент].ИД;	 
	Иначе
	    Возврат;
	КонецЕсли
	ПИ.НачатьТранзакцию();
	ПИ.УстановитьИмяИдентификатора("Ид");
	ПИ.УстановитьИдентификаторОбъекта(СледИД);
	ПИ.НайтиЭлементВБД(); 
	ПИ.Позиция=ТекПозиция;
	ПИ.Записать();
	ПИ.УстановитьИмяИдентификатора("Ид");
	ПИ.УстановитьИдентификаторОбъекта(ТекИД);
	ПИ.НайтиЭлементВБД(); 
	ПИ.Позиция=СледПозиция;
	ПИ.Записать();
	ПИ.ЗафиксироватьТранзакцию();
	Дерево.УдалитьВсе();
	ПостроитьДерево();
КонецПроцедуры//ПриНажатииКнВниз