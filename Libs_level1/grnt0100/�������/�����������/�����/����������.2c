Перем Интерфейс;
Перем ИмяИнтерфейса;
Перем ГМ;
Перем ГМСтр;
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
	Конт=Форма.Параметр;
	Если ТипЗначенияСтр(Конт)="СписокЗначений" Тогда
		ГМ=СоздатьОбъект("ГлавноеМеню");
		МД=СоздатьОбъект("ФайлМетаданных");
		
        Интерфейс=Конт.ПолучитьЗначение(1);
        ИмяИнтерфейса=Конт.ПолучитьЗначение(2);
		ПостроитьДерево();
	Иначе
	    Форма.Закрыть();		 
	КонецЕсли
	
КонецПроцедуры
///////////////////////////////////////////////////////////////////////
Процедура ОткрытьМастер()
    Сп=СоздатьОбъект("СписокЗначений");
    Сп.ДобавитьЗначение(Интерфейс); 
    ОткрытьФормуМодально("Объекты\ГлавноеМеню\Формы\Мастер",Сп);
    Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ОткрытьМастер
///////////////////////////////////////////////////////////////////////
Процедура УдалитьЭлементМеню()
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс: "+ИмяИнтерфейса+">" Тогда
	    Возврат;
	Иначе
        Ответ=Вопрос("Вы действительно хотите удалить элемент меню <"+ТекстВыделенный+">?",4);
        Если Ответ=6 Тогда
            ГМ.НачатьТранзакцию();
			ГМ.УстановитьИмяИдентификатора("ИД");
			ГМ.УстановитьИдентификаторОбъекта(ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД);
			ГМ.НайтиЭлементВБД();
			Родитель=ГМ.Родитель;
			ГМ.Удалить();
			ГМ.ВыбратьЭлементыМеню(Интерфейс,Родитель);
			Позиция=1;
			Пока ГМ.ПолучитьЭлемент()=1 Цикл
				ГМ.Позиция=Позиция;
				ГМ.Записать();
				Позиция=Позиция+1; 
			КонецЦикла
			ГМ.ЗафиксироватьТранзакцию();
			Дерево.УдалитьВсе();
    		ПостроитьДерево(); 
		КонецЕсли;	
	КонецЕсли
КонецПроцедуры//УдалитьЭлементМеню  
///////////////////////////////////////////////////////////////////////
Процедура ОткрытьЭлементМеню()
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Родитель=0;
	    ТекЭлемент=0;
	    ТекПозиция=РазмерСтруктуры(ГМСтр)+1;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    ГМ.УстановитьИмяИдентификатора("Ид");
	    ГМ.УстановитьИдентификаторОбъекта(ГМСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))].ИД);
	    ГМ.НайтиЭлементВБД();
	    Родитель=ГМ.ИД;
	    ТекЭлемент=0;
	    ТекПозиция=РазмерСтруктуры(ГМСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))])+1;
	ИначеЕсли ТекстВыделенный="<Интерфейс: "+ИмяИнтерфейса+">" Тогда
	    Возврат;
	Иначе
        ГМ.УстановитьИмяИдентификатора("Ид");
 	    ГМ.УстановитьИдентификаторОбъекта(ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД);
 	    ГМ.НайтиЭлементВБД();
	    ТекЭлемент=ГМ.ИД;
	    Родитель=ГМ.Родитель;
	    ТекПозиция=ГМ.Позиция;
 	КонецЕсли;
	Сп=СоздатьОбъект("СписокЗначений");
	Сп.ДобавитьЗначение(ТекЭлемент);
	Сп.ДобавитьЗначение(Родитель);
	Сп.ДобавитьЗначение(ТекПозиция);
	Сп.ДобавитьЗначение(ТекстВыделенный);
	Сп.ДобавитьЗначение(Интерфейс);
	ОткрытьФормуМодально("Объекты\ГлавноеМеню\Формы\ЭлементМеню",Сп);
	Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ОткрытьЭлементМеню 
///////////////////////////////////////////////////////////////////////
Процедура ПостроитьДерево()
    ГМСтр=СоздатьОбъект("Структура");
    ГМ.ВыбратьЭлементыМеню(Интерфейс,0);
    Корень=Дерево.ВставитьЭлемент("<Интерфейс:"+ИмяИнтерфейса+">",541);
    Пока ГМ.ПолучитьЭлемент()=1 Цикл
    	ТекЭлемент=Дерево.ВставитьЭлемент(ГМ.Заголовок,253,Корень);
        ИД=ГМ.ИД;
        Позиция=ГМ.Позиция;
        ГМСтр[Строка(ТекЭлемент)]["ИД"]=ИД;
        ГМСтр[Строка(ТекЭлемент)]["Позиция"]=Позиция;
    	ГМ1=СоздатьОбъект("ГлавноеМеню");
    	ГМ1.ВыбратьЭлементыМеню(Интерфейс,ГМ.ИД);
    	Пока ГМ1.ПолучитьЭлемент()=1 Цикл
    		ТЭ=Дерево.ВставитьЭлемент(ГМ1.Заголовок,254,ТекЭлемент);
    		ИД=ГМ1.ИД;
        	Позиция=ГМ1.Позиция;
        	ГМСтр[Строка(ТЭ)]["ИД"]=ИД;
        	ГМСтр[Строка(ТЭ)]["Позиция"]=Позиция;
       	КонецЦикла
    	Дерево.ВставитьЭлемент("<новый...>",255,ТекЭлемент);
    КонецЦикла;
    Дерево.ВставитьЭлемент("<новая колонка...>",255,Корень);
    Дерево.Разворот(Корень);
КонецПроцедуры//ПостроитьДерево
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры
//Процедура обработки нажатия кнопки КнВверх
Процедура ПриНажатииКнВверх()
    ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
	    Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
	    Возврат;
	КонецЕсли;    
    
    ТекПозиция=ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].Позиция;
    ТекИД=ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД;
    ПредПозиция=ТекПозиция;
    ПредИД=ТекИД;
    НачЭлементСписка=Строка(Дерево.ПолучитьПодчиненный(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент())));
    Элемент=НачЭлементСписка;
    Пока 1=1 Цикл
        Если ГМСтр[Элемент].ИД=ТекИД Тогда
        	Прервать; 
        КонецЕсли;
        ПредИД=ГМСтр[Элемент].ИД;
        ПредПозиция=ГМСтр[Элемент].Позиция;
        Элемент=Строка(Дерево.ПолучитьСледующий(Число(Элемент)));
    КонецЦикла
    
    Если ТекИД=ПредИД Тогда
    Иначе
        ГМ.НачатьТранзакцию();
        ГМ.УстановитьИмяИдентификатора("Ид");
 	    ГМ.УстановитьИдентификаторОбъекта(ПредИД);
 	    ГМ.НайтиЭлементВБД(); 
 	    ГМ.Позиция=ТекПозиция;
 	    ГМ.Записать();
 	    ГМ.УстановитьИмяИдентификатора("Ид");
 	    ГМ.УстановитьИдентификаторОбъекта(ТекИД);
 	    ГМ.НайтиЭлементВБД(); 
 	    ГМ.Позиция=ПредПозиция;
 	    ГМ.Записать();
 	    ГМ.ЗафиксироватьТранзакцию();
    КонецЕсли
    Дерево.УдалитьВсе();
    ПостроитьДерево();
КонецПроцедуры//ПриНажатииКнВверх

//Процедура обработки нажатия кнопки КнВниз
Процедура ПриНажатииКнВниз()
	ТекстВыделенный=Дерево.ПолучитьТекст(Дерево.ВыделенныйЭлемент()); 
	Если ТекстВыделенный="<новая колонка...>" Тогда
		Возврат;
	ИначеЕсли ТекстВыделенный="<новый...>" Тогда
		Возврат;
	ИначеЕсли ТекстВыделенный="<Интерфейс:"+ИмяИнтерфейса+">" Тогда
		Возврат;
	КонецЕсли;    
	ВсегоПозиций=РазмерСтруктуры(ГМСтр[Строка(Дерево.ПолучитьРодителя(Дерево.ВыделенныйЭлемент()))]);
	ТекПозиция=ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].Позиция;
	ТекИД=ГМСтр[Строка(Дерево.ВыделенныйЭлемент())].ИД;
	СледЭлемент=Строка(Дерево.ПолучитьСледующий(Дерево.ВыделенныйЭлемент()));
	Если ТипЗначенияСтр(ГМСтр[СледЭлемент])="Массив" Тогда
	    СледПозиция=ГМСтр[СледЭлемент].Позиция;
	    СледИД=ГМСтр[СледЭлемент].ИД;	 
	Иначе
	    Возврат;
	КонецЕсли
	ГМ.НачатьТранзакцию();
	ГМ.УстановитьИмяИдентификатора("Ид");
	ГМ.УстановитьИдентификаторОбъекта(СледИД);
	ГМ.НайтиЭлементВБД(); 
	ГМ.Позиция=ТекПозиция;
	ГМ.Записать();
	ГМ.УстановитьИмяИдентификатора("Ид");
	ГМ.УстановитьИдентификаторОбъекта(ТекИД);
	ГМ.НайтиЭлементВБД(); 
	ГМ.Позиция=СледПозиция;
	ГМ.Записать();
	ГМ.ЗафиксироватьТранзакцию();
	Дерево.УдалитьВсе();
	ПостроитьДерево();
КонецПроцедуры//ПриНажатииКнВниз