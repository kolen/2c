//Автор:  Alex_Bob 
//E-mail: asbobylk@svsokol.lipetsk.ru
//Версия модуля: 1.02 от 27.07.2004
//Релиз платформы: от 06.07.2004

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Перем СписокНП;

Процедура ПриОткрытии()
    СписокНП=СоздатьОбъект("НаборыПрав");
    ТЗ.НоваяКолонка("Ид",,,,"№",30);
    ТЗ.НоваяКолонка("Наименование",,,,,60);
    СписокНП.ВыбратьЭлементы();
    Пока СписокНП.ПолучитьЭлемент()=1 Цикл
    	ТЗ.НоваяСтрока();
    	ТЗ.ИД=СписокНП.ИД;
    	ТЗ.Наименование=СписокНП.Имя;
    КонецЦикла;
    ТЗ.ТекущаяСтрока(1); 	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки КнНовый
Процедура НовыйНП()
    ИД=Число(ПолучитьЗначениеЗапроса("SELECT max("+СписокНП.ПолучитьИмяПоляБД("ИД")+") FROM "+СписокНП.ИмяТаблицыОбъекта()))+1;
    СписокНП.НачатьТранзакцию();
    ИмяНП="";
    Если ВвестиСтроку(ИмяНП,"Введите наименование набора прав:",50)=1 Тогда
    	СписокНП.Новый();
    	СписокНП.ИД=ИД;
    	СписокНП.Имя=ИмяНП;
    	СписокНП.Записать();
        СписокНП.ЗафиксироватьТранзакцию();
        ТЗ.НоваяСтрока();
    	ТЗ.ИД=СписокНП.ИД;
    	ТЗ.Наименование=СписокНП.Имя;
    	ТЗ.ПолучитьСтрокуПоНомеру(ТЗ.КоличествоСтрок());
    Иначе
        СписокНП.ОтменитьТранзакцию();	 
    КонецЕсли;
  
КонецПроцедуры //НовыйНП

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки КнИзменить
Процедура ИзменитьНП()
	Если ТЗ.ТекущаяСтрока()=0 Тогда
		Предупреждение("Выберите конкретную строку списка!");
		Возврат; 
	КонецЕсли
	
    ТЗ.ПолучитьСтрокуПоНомеру(ТЗ.ТекущаяСтрока());
    Если СокрЛП(ТЗ.Наименование)="Администратор" Тогда
		Предупреждение("Набор прав администратора изменить нельзя!");
		Возврат
	КонецЕсли
    ИмяНП=ТЗ.Имя;
    Если ВвестиСтроку(ИмяНП,"Введите наименование набора прав:",50)=1 Тогда
    	СписокНП.УстановитьИмяИдентификатора("ИД");
    	СписокНП.УстановитьИдентификаторОбъекта(ТЗ.ИД);
    	СписокНП.НайтиЭлементВБД();
    	СписокНП.Имя=ИмяНП;
    	СписокНП.Записать();	 
    КонецЕсли
    
    ТЗ.ИД=СписокНП.ИД;
    ТЗ.Наименование=СписокНП.Имя;
КонецПроцедуры //ИзменитьНП

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки КнУдалить
Процедура УдалитьНП()
    Если ТЗ.ТекущаяСтрока()=0 Тогда
		Предупреждение("Выберите конкретную строку списка!");
		Возврат; 
	КонецЕсли
	ТЗ.ПолучитьСтрокуПоНомеру(ТЗ.ТекущаяСтрока());
	Если СокрЛП(ТЗ.Наименование)="Администратор" Тогда
		Предупреждение("Набор прав администратора удалить нельзя!");
		Возврат
	КонецЕсли
	Ответ=Вопрос("Вы действительно хотите удалить набор прав "+ТЗ.Наименование+"?",4);
	Если Ответ=6 Тогда
		СписокНП.УстановитьИмяИдентификатора("ИД");
		СписокНП.УстановитьИдентификаторОбъекта(ТЗ.ИД);
		СписокНП.Удалить();
		ТЗ.УдалитьСтроку(ТЗ.ТекущаяСтрока()); 
	КонецЕсли
КонецПроцедуры //УдалитьНП  

/////////////////////////////////////////////////////////////////////

Функция ПолучитьЗначениеЗапроса(Текст)
	СписокНП.Запрос(Текст);
	Если СписокНП.ПолучитьСтроку()=1 Тогда
		Возврат СписокНП.ПолучитьПоле(1);
	КонецЕсли
	Возврат "";
КонецФункции

Процедура ПоказатьПрава()
    Если ТЗ.ТекущаяСтрока()=0 Тогда
		Предупреждение("Выберите конкретную строку списка!");
		Возврат; 
	КонецЕсли
    Сп=СоздатьОбъект("СписокЗначений");
    ТЗ.ПолучитьСтрокуПоНомеру(ТЗ.ТекущаяСтрока());
    Сп.ДобавитьЗначение(ТЗ.ИД);
    Сп.ДобавитьЗначение(ТЗ.Наименование);
	ОткрытьФормуМодально("Объекты\ПраваДоступа\Формы\СписокПрав",Сп);
КонецПроцедуры //ПоказатьПрава