Перем ТипОбъекта;
Перем МасВидов Экспорт;

//#Задать _Отладка
#Если _Отладка
	Перем глНомерОбъекта Экспорт;//Статично;
#КонецЕсли

//___________________________________________________________________________________________
Функция ТипОбъекта()Экспорт
	 Возврат ТипОбъекта;
КонецФункции//ТипОбъекта

//******************************************************************************************
//Предопределенные процедуры и функции в режиме Предприятия
//******************************************************************************************
Процедура ПриНачалеРаботыСистемы()
	Мета=СоздатьОбъект("Метаданные").Массив["Метаданные"];
	
	
	ТипОбъекта="Регистр";
	
	//регистрируем синоним
	//ЗарегистрироватьОбъект("Регистр","Регистры");

	СписокПодГрупп=СоздатьОбъект("Массив"); 
	СписокПодГрупп[1]="Измерения";
	СписокПодГрупп[2]="Ресурсы";
	СписокПодГрупп[3]="Реквизиты";
	
	//читаем виды
	Если РазмерСтруктуры(Мета) Тогда
		Для А=1 По РазмерСтруктуры(Мета[ТипОбъекта]) Цикл
			Вид=Мета[ТипОбъекта].ИдентификаторПоНомеру(А);
			ИдентификаторБД=ПолучитьИдентификаторБД(ТипОбъекта+"/"+Вид);
			

			//Шапочная часть
			РегистрБД=СоздатьОбъект("ТаблицаБД");
			//РегистрБД.ДобавитьПоле("ПериодДвижения","Число",17,0);//ГГГГММЧЧ + СЕК (ЧЧММСС) + МСЕК (000-999)
			РегистрБД.ДобавитьПоле("#ПозицияОсиВремени","Строка",30,0);//ГГГГММЧЧччммсс + Прав(ИД,16), т.е. Год, Месяц, Число, час, минута, сек + 16 правых символов ИД объекта
			РегистрБД.ДобавитьПоле("#ТипДвижения","Строка",1,0);//Символ: "+" или "-"
			РегистрБД.ДобавитьПоле("#ТекущийДокумент","Документ",0,0);
			РегистрБД.ДобавитьПоле("#НомерСтроки","Число",15,0);
			
			Для ПодГруппа=1 По 3 Цикл
				ИмяПодгурппы=СписокПодГрупп[ПодГруппа];
				МетаОбъект=Мета[ТипОбъекта][Вид][ИмяПодгурппы];
				Для Б=1 По РазмерСтруктуры(МетаОбъект) Цикл
					Имя=МетаОбъект.ИдентификаторПоНомеру(Б);
					РегистрБД.ДобавитьПоле(Имя,МетаОбъект[Имя].Тип,МетаОбъект[Имя].Длина,МетаОбъект[Имя].Точность);
				КонецЦикла;
			КонецЦикла
			
			ТипВид=ТипОбъекта+"."+Вид;
			Если ПустоеЗначение(ИдентификаторБД)=1 Тогда
				ТипВидБД=ТипВид;
			Иначе
				ТипВидБД=ТипОбъекта+"."+ИдентификаторБД;
			КонецЕсли
			РегистрБД.НачальнаяИнициализация(ТипВид,"RT",0,0,ТипВидБД);
		КонецЦикла;
	КонецЕсли;
	
	МасВидов=СоздатьОбъект("Метаданные").Массив["Метаданные"][ТипОбъекта];
	
	Регистр=СоздатьОбъект("Регистр");
	УстановитьТолькоЧтение(Регистр,1);
	
	
	ПодписатьсяНаСобытие("ТаблицаБДСписок:СозданиеКонтекстногоМеню","СозданиеКонтекстногоМеню");
КонецПроцедуры


//___________________________________________________________________________________________
Процедура СозданиеКонтекстногоМеню(Результат,ТекОбъект,СписокМеню)
	//ТекОбъект:Документ
	Если ВРЕГ(ТипЗначенияСтр(ТекОбъект))="ДОКУМЕНТ" Тогда
		Если ТекОбъект.Выбран() И ТекОбъект.Проведен() Тогда
			Спис=СоздатьОбъект("СписокЗначений");
			Рег=СоздатьОбъект("Регистр");
			Для А=1 По Рег.ПолучитьКоличествоАтрибутов() Цикл
				Имя=Рег.ПолучитьИмяАтрибута(А);
				Попытка
					Рег2=СоздатьОбъект("Регистр."+Имя);
					Рез=Рег2.ВыбратьДвиженияДокумента(ТекОбъект);
					Спис.ДобавитьЗначение(Контекст,Имя);
					Если Рез Тогда
						Спис.Пометка(Спис.РазмерСписка(),1);
					КонецЕсли
				Исключение
					Продолжить;
				КонецПопытки
			КонецЦикла

			
			
			СписокМеню.ДобавитьЗначение("");
			Если СписокМеню.РазмерСписка()>0 Тогда
				СписокМеню.ДобавитьЗначение(Спис,"Движения по регистрам");
			КонецЕсли
		КонецЕсли
	КонецЕсли
КонецПроцедуры//СозданиеКонтекстногоМеню


//___________________________________________________________________________________________
Процедура ВыполнитьКомандуМеню(Вид,ТекОбъект)Экспорт//выполнение команды контекстного меню
	//ОткрытьФорму("ДвиженияДокумента",ПолучитьМассив(Вид,ТекОбъект));
КонецПроцедуры//ВыполнитьКоманду
