Перем ЖС;
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
	ЖС=СоздатьОбъект("БазаДанных");
	Таблица.НоваяКолонка("Режим");
	Таблица.НоваяКолонка("Пользователь");
	Таблица.НоваяКолонка("Компьютер");
	Таблица.ВыводитьПиктограммы("Режим");
	ВыбратьАктивных();
	УстановитьТаймер("Обновить",10000);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Выполнить
Процедура ВыбратьАктивных()
    ЖС.Запрос("select max(datetime) as maxd,reg,user,comp,event from log where (event='Подключение' or event='Отключение') group by reg, user, comp, event order by reg,user,comp,maxd");
    Таблица.УдалитьСтроки();
    Пока ЖС.ПолучитьСтроку()=1 Цикл
	    Если ЖС.ПолучитьПоле(5)="Подключение" Тогда
	    	Таблица.НоваяСтрока();
	    	Таблица.Режим=ПолучитьПиктограммуРежима(Число(ЖС.ПолучитьПоле(2)));
	    	Таблица.Пользователь=ЖС.ПолучитьПоле(3);
	    	Таблица.Компьютер=ЖС.ПолучитьПоле(4);
	    	Режим=ПолучитьПиктограммуРежима(Число(ЖС.ПолучитьПоле(2)));
	    	Пользователь=ЖС.ПолучитьПоле(3);
	    	Компьютер=ЖС.ПолучитьПоле(4);
	    КонецЕсли
	    Если (ЖС.ПолучитьПоле(5)="Отключение") И
		     (Режим=ПолучитьПиктограммуРежима(Число(ЖС.ПолучитьПоле(2)))) И
		     (Пользователь=ЖС.ПолучитьПоле(3)) И
		     (Компьютер=ЖС.ПолучитьПоле(4)) Тогда
	       	Таблица.ПолучитьСтрокуПоНомеру(Таблица.КоличествоСтрок());
	       	Таблица.УдалитьСтроку();
	    КонецЕсли

    КонецЦикла
КонецПроцедуры

//___________________________________________________________________________________________
Функция ПолучитьПиктограммуРежима(Реж)
	Если Реж=0  Тогда //Конфигуратор
		Возврат 375;
	ИначеЕсли Реж=1  Тогда //Предприятие
		Возврат 146;	
	ИначеЕсли Реж=2  Тогда //Монопольный
		Возврат 434;
	ИначеЕсли Реж=3  Тогда //Монопольный
		Возврат 434;
	ИначеЕсли Реж>3  Тогда //Сервер
		Возврат 340;						
	КонецЕсли
	
КонецФункции//ПолучитьПиктограммуРежима()

Процедура Обновить()
	ВыбратьАктивных();
КонецПроцедуры//Обновить
