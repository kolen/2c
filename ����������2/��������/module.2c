///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Выполнить
Процедура Выполнить()
    Мета=СоздатьОбъект("ФайлМетаданных"); 
    Мас=СоздатьОбъект("Массив");
    
	Мета.Открыть(ИмяФайла,1); 
	ФС=СоздатьОбъект("Файловая система");
	ФС.СоздатьКаталог(Лев(ИмяФайла,СтрДлина(ИмяФайла)-4));
	Для А=1 По Мета.КоличествоЭлементов() Цикл 
    	Мас[А]=Мета.ПолучитьИмя(А);
    КонецЦикла;
    Мас.Сортировать();
    Для А=1 По РазмерМассива(Мас) Цикл
        Имя=Мас[А]; 
    	Стр=Мета.ПрочитатьТекст(Имя);
    	Стр=СтрЗаменить(Стр,Симв(13),""); 
    	Имя1=СтрЗаменить(Имя," ","__");
	    Если Прав(Имя,4)=".atr" Тогда
	    ИначеЕсли Прав(Имя,4)=".inf" Тогда
		ИначеЕсли Прав(Имя,4)=".frm" Тогда
	    ИначеЕсли Прав(Имя,1)="\" Тогда
		    Продолжить;
	    Иначе
		    Если Лев(Стр,5)="{\rtf" Тогда
			    Имя1=Имя1+".rtf";
		    ИначеЕсли Лев(Стр,5)="MYMXL" Тогда
			    //не буду пока связываться с таблицами вообще 
//				Имя2=Имя1+".mxl";
//				ИмяФайлаТек=Лев(ИмяФайла,СтрДлина(ИмяФайла)-4)+"\"+Имя2;
//				ИмяКаталога=ВыделитьИмяКаталога(ИмяФайлаТек);
// 				СтрКоманды=КаталогПрограммы()+"7z.exe";
// 				СтрПараметров="e "+ИмяФайла+" """+Имя+""" -o"+ИмяКаталога; 
//                ЗапуститьПриложение(СтрКоманды,СтрПараметров);
//                Пока ФС.СуществуетФайл(Лев(ИмяФайла,СтрДлина(ИмяФайла)-4)+"\"+Имя1)=0 Цикл
//                	Пауза(100);
//                КонецЦикла
//                ФС.ПереименоватьФайл(Лев(ИмяФайла,СтрДлина(ИмяФайла)-4)+"\"+Имя1,ИмяФайлаТек); 
				Продолжить;  
			Иначе       
		    	Имя1=Имя1+".2c";   
		    КонецЕсли
    	КонецЕсли
 		ИмяФайлаТек=Лев(ИмяФайла,СтрДлина(ИмяФайла)-4)+"\"+Имя1;
 		Текст=СоздатьОбъект("Текст");
 		Текст1=СоздатьОбъект("Текст");
 		Текст.ДобавитьСтроку(Стр);
 		ИмяКаталога=ВыделитьИмяКаталога(ИмяФайлаТек);
 		ФС.СоздатьКаталог(ИмяКаталога);
 		Текст.Записать(ИмяФайлаТек);
 		
	КонецЦикла
КонецПроцедуры

//Процедура обработки нажатия кнопки <...> - выполняет выбор файла
Процедура ПриВыбореФайла()
	ИмяФайлаПоУмолчанию="";
    ФС=СоздатьОбъект("Файловая система");
    ФС.ВыбратьФайл(0,ИмяФайлаПоУмолчанию,,"Выберите файл MD2:","Файлы MD2|*.md2");
    ИмяФайла=ИмяФайлаПоУмолчанию;
КонецПроцедуры

Функция ВыделитьИмяКаталога(Знач ИмяФ)
	ИмяКаталога="";
	Поз=Найти(ИмяФ,"\");
	Пока Поз>0 Цикл
		ИмяКаталога=ИмяКаталога+Сред(ИмяФ,1,Поз);
		ИмяФ=Сред(ИмяФ,Поз+1);
		Поз=Найти(ИмяФ,"\");
	КонецЦикла
    Сообщить(ИмяКаталога);
    Возврат ИмяКаталога;
КонецФункции //ВыделитьИмяКаталога(ИмяФ)

