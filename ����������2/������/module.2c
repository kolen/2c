Перем ИмяФайла;
Перем Мета;
///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при первом открытии формы
Процедура ПриОткрытии()
	//глВосстановитьЗначенияФормы(Контекст);
	ТипФайла=2;
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Предопределенная процедура - вызывается при закрытии формы
Процедура ПриЗакрытии()
//	Если СостояниеКлавиши(27) Тогда
//		СтатусВозврата(0);
//	КонецЕсли;
//	глЗапомнитьЗначенияФормы(Контекст);
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Закрыть - выполняет закрытие формы
Процедура ЗакрытьФорму()
	Форма.Закрыть();
КонецПроцедуры

///////////////////////////////////////////////////////////////////////
//Процедура обработки нажатия кнопки Выполнить
Процедура Выполнить()
    Мета=СоздатьОбъект("ФайлМетаданных"); 
    ФС=СоздатьОбъект("Файловая система");
    Если ТипФайла=2 Тогда
        ИмяФайла=Лев(ИмяКаталога,СтрДлина(ИмяКаталога)-1)+".md2";
    ИначеЕсли ТипФайла=1 Тогда
	    ИмяФайла=Лев(ИмяКаталога,СтрДлина(ИмяКаталога)-1)+".fd";    	
    КонецЕсли

    
    Если ФС.СуществуетФайл(ИмяФайла) Тогда
    	Предупреждение("Существующий файл "+ИмяФайла+" будет переименован в файл с расширением .!md2");
    	ИмяФайла1=Лев(ИмяФайла,СтрДлина(ИмяФайла)-4)+".!md2";
    	ФС.ПереименоватьФайл(ИмяФайла,ИмяФайла1,1);
    КонецЕсли
    Мета.Открыть(ИмяФайла);
    РекурсивнаяСборка("");
 	Мета.Закрыть();
КонецПроцедуры

//Процедура обработки нажатия кнопки <...> - выполняет выбор файла
Процедура ПриВыбореКаталога()
	ИмяКаталогаПоУмолчанию=ИмяКаталога;
    ФС=СоздатьОбъект("Файловая система");
    ФС.ВыбратьКаталог(ИмяКаталогаПоУмолчанию,"Выберите каталог для сборки MD2:");
    ИмяКаталога=ИмяКаталогаПоУмолчанию;
КонецПроцедуры

Процедура РекурсивнаяСборка(Путь)
	ФС=СоздатьОбъект("Файловая система");
	СписокФайлов=СоздатьОбъект("СписокЗначений");
	ФС.УстТекКаталог(ИмяКаталога+Путь);
	ТекФайл=ФС.НайтиПервыйФайл("*.*");
	Пока ПустоеЗначение(ТекФайл)=0 Цикл
		СписокФайлов.ДобавитьЗначение(ТекФайл);
		ТекФайл=ФС.НайтиСледующийФайл();
	КонецЦикла;	
	Для А=1 По СписокФайлов.РазмерСписка() Цикл
		ТекФайл=СписокФайлов.ПолучитьЗначение(А);
		Если (ТекФайл=".") ИЛИ (ТекФайл="..") Тогда
		   	Продолжить;
		ИначеЕсли Прав(ТекФайл,4)=".atr" Тогда
			Имя=ТекФайл;
		ИначеЕсли Прав(ТекФайл,4)=".inf" Тогда
			Имя=ТекФайл;
		ИначеЕсли Прав(ТекФайл,4)=".frm" Тогда
			Имя=ТекФайл;
		ИначеЕсли Прав(ТекФайл,4)=".rtf" Тогда
			Имя=Лев(ТекФайл,СтрДлина(ТекФайл)-4);
		ИначеЕсли Прав(ТекФайл,4)=".mxl" Тогда
//			Имя=Лев(ТекФайл,СтрДлина(ТекФайл)-4);
            Продолжить; 		
		ИначеЕсли Прав(ТекФайл,3)=".2c" Тогда
			Имя=Лев(ТекФайл,СтрДлина(ТекФайл)-3);
		ИначеЕсли Прав(ТекФайл,3)="CVS" Тогда
			Продолжить;
		Иначе
			//считаем, что каталог
		    РекурсивнаяСборка(Путь+ТекФайл+"\");
		    Продолжить;
    	КонецЕсли
    	ПутьИмя=СтрЗаменить(Путь+Имя,"__"," ");
    	Текст=СоздатьОбъект("Текст");
    	Текст.Открыть(ИмяКаталога+Путь+ТекФайл);
    	КолСтрок=Текст.КоличествоСтрок();
        Стр=""; 
    	Если КолСтрок>0 Тогда
	    	Для Б=1 По КолСтрок Цикл
		    	Если Б=1 Тогда
		    		Стр=Текст.ПолучитьСтроку(Б);
		    	Иначе
			    	Стр=Стр+Симв(13)+Симв(10)+Текст.ПолучитьСтроку(Б);	
		    	КонецЕсли
	    	КонецЦикла
    	КонецЕсли
        Мета.ЗаписатьТекст(ПутьИмя,Стр);
 	КонецЦикла
КонецПроцедуры//РекурсивнаяСборка(Путь)
